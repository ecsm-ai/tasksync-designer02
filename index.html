import React, { useEffect, useMemo, useState } from "react";

// ===== Utilities =====
const fmt = (d: Date) => d.toISOString().slice(0, 10);
const parse = (s: string) => new Date(s + "T00:00:00");
const addDays = (d: Date, n: number) => new Date(d.getFullYear(), d.getMonth(), d.getDate() + n);
const diffDays = (a: Date, b: Date) => Math.floor((a.getTime() - b.getTime()) / 86400000);
const startOfWeek = (d: Date) => addDays(d, -((d.getDay() + 6) % 7)); // Monday start
const startOfMonth = (d: Date) => new Date(d.getFullYear(), d.getMonth(), 1);
const daysInMonth = (d: Date) => new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
const today = new Date();

// ===== Types =====
type Task = {
  id: string;
  title: string;
  client: string;
  project: string;
  start: string; // yyyy-mm-dd
  end: string;   // yyyy-mm-dd
  progress: number;
  priority: "High" | "Medium" | "Low";
  notes?: string;
  status: "Planned" | "In Progress" | "Blocked" | "Done";
  messages?: string[]; // クライアント依頼メモ（擬似チャット）
};

// ===== Seed =====
const seedTasks: Task[] = [
  {
    id: "t1",
    title: "LPデザイン（構成案）",
    client: "Acme Co.",
    project: "ECサイト刷新",
    start: fmt(addDays(today, -2)),
    end: fmt(addDays(today, 3)),
    progress: 60,
    priority: "High",
    notes: "ワイヤー確定後にビジュアル着手",
    status: "In Progress",
    messages: ["構成案はA/Bの2本で検討","CTAは今週確定予定"],
  },
  {
    id: "t2",
    title: "バナー3種",
    client: "Beta Studio",
    project: "キャンペーンA/W",
    start: fmt(addDays(today, -1)),
    end: fmt(addDays(today, 8)),
    progress: 20,
    priority: "Medium",
    notes: "文言は支給待ち",
    status: "Planned",
    messages: ["サイズは300x250/728x90/1080x1350"],
  },
  {
    id: "t3",
    title: "ロゴ微調整",
    client: "Acme Co.",
    project: "ブランドガイド",
    start: fmt(addDays(today, 1)),
    end: fmt(addDays(today, 4)),
    progress: 0,
    priority: "Low",
    notes: "配色パターン3案",
    status: "Planned",
    messages: [],
  },
];

// ===== Main App =====
export default function App() {
  // --- core state ---
  const [tasks, setTasks] = useState<Task[]>(() => {
    const saved = localStorage.getItem("tsd_tasks");
    return saved ? JSON.parse(saved) : seedTasks;
  });
  const [view, setView] = useState<"week" | "month">("week");
  const [selectedId, setSelectedId] = useState<string | null>(tasks[0]?.id ?? null);
  const [filterClient, setFilterClient] = useState<string>("all");
  const [filterPreset, setFilterPreset] = useState<"all" | "today" | "week" | "overdue">("all");
  const [showNew, setShowNew] = useState(false);
  const [theme, setTheme] = useState<"light" | "dark">(() => (localStorage.getItem("tsd_theme") as any) || "light");

  // --- derived ---
  useEffect(() => localStorage.setItem("tsd_tasks", JSON.stringify(tasks)), [tasks]);
  useEffect(() => localStorage.setItem("tsd_theme", theme), [theme]);

  const rangeStart = view === "week" ? startOfWeek(today) : startOfMonth(today);
  const totalDays = view === "week" ? 7 : daysInMonth(today);
  const headerDays = useMemo(() => Array.from({ length: totalDays }, (_, i) => addDays(rangeStart, i)), [view]);

  const clients = useMemo(() => Array.from(new Set(tasks.map((t) => t.client))), [tasks]);

  const presetFilterFn = (t: Task) => {
    const s = parse(t.start), e = parse(t.end);
    const isOverdue = e < new Date(fmt(today)) && t.status !== "Done";
    if (filterPreset === "today") return s <= today && e >= today;
    if (filterPreset === "week") {
      const endOfWeek = addDays(startOfWeek(today), 6);
      return (s <= endOfWeek && e >= startOfWeek(today));
    }
    if (filterPreset === "overdue") return isOverdue;
    return true;
  };

  const visible = useMemo(() => {
    return tasks.filter((t) => (filterClient === "all" ? true : t.client === filterClient)).filter(presetFilterFn);
  }, [tasks, filterClient, filterPreset, view]);

  const selected = tasks.find((t) => t.id === selectedId) || null;

  // --- CRUD ---
  function createTask(newTask: Omit<Task, "id">) {
    setTasks((prev) => [{ ...newTask, id: "t" + (prev.length + 1) }, ...prev]);
    setShowNew(false);
  }
  function updateTask(id: string, patch: Partial<Task>) {
    setTasks((prev) => prev.map((t) => (t.id === id ? { ...t, ...patch } : t)));
  }
  function shiftTask(id: string, dir: number) {
    const t = tasks.find((x) => x.id === id);
    if (!t) return;
    const nStart = fmt(addDays(parse(t.start), dir));
    const nEnd = fmt(addDays(parse(t.end), dir));
    updateTask(id, { start: nStart, end: nEnd });
  }
  function addMessage(id: string, text: string) {
    const task = tasks.find((x) => x.id === id);
    if (!task) return;
    const messages = [...(task.messages || []), text];
    updateTask(id, { messages });
  }

  // --- theme classes ---
  const rootClasses = theme === "dark" ? "min-h-screen bg-neutral-900 text-neutral-100" : "min-h-screen bg-gray-50 text-gray-900";
  const card = theme === "dark" ? "bg-neutral-800 border-neutral-700" : "bg-white border";
  const rail = theme === "dark" ? "bg-neutral-700" : "bg-gray-100";

  return (
    <div className={rootClasses}>
      {/* Header */}
      <div className={`${card} sticky top-0 z-10 border-b`}>
        <div className="mx-auto max-w-7xl px-4 py-3 flex items-center gap-3">
          <div className="font-bold text-lg">TaskSync Designer</div>
          <div className="ml-4 hidden md:flex gap-2 text-sm">
            <PresetButton label="すべて" active={filterPreset === "all"} onClick={() => setFilterPreset("all")} />
            <PresetButton label="今日" active={filterPreset === "today"} onClick={() => setFilterPreset("today")} />
            <PresetButton label="今週" active={filterPreset === "week"} onClick={() => setFilterPreset("week")} />
            <PresetButton label="期限切れ" active={filterPreset === "overdue"} onClick={() => setFilterPreset("overdue")} />
          </div>
          <div className="ml-auto flex items-center gap-2">
            <button className="px-3 py-1 rounded border" onClick={() => setTheme(theme === "dark" ? "light" : "dark")}>{theme === "dark" ? "☀️" : "🌙"}</button>
            <button className="px-3 py-1 rounded bg-indigo-600 text-white" onClick={() => setShowNew(true)}>新規タスク</button>
          </div>
        </div>
      </div>

      {/* Body */}
      <div className="mx-auto max-w-7xl px-4 py-4 grid grid-cols-12 gap-4">
        {/* Sidebar */}
        <aside className={`col-span-12 md:col-span-3 lg:col-span-2 ${card} rounded-xl p-3 h-fit`}>
          <div className="text-sm font-semibold mb-2">クライアント絞り込み</div>
          <select className="w-full border rounded px-2 py-1 bg-transparent" value={filterClient} onChange={(e) => setFilterClient(e.target.value)}>
            <option value="all">すべて</option>
            {clients.map((c) => (
              <option key={c} value={c}>{c}</option>
            ))}
          </select>

          <div className="mt-4">
            <div className="text-sm font-semibold mb-1">ビュー</div>
            <div className="flex gap-2">
              <button onClick={() => setView("week")} className={`px-3 py-1 rounded border ${view === "week" ? "bg-indigo-600 text-white" : "bg-transparent"}`}>週</button>
              <button onClick={() => setView("month")} className={`px-3 py-1 rounded border ${view === "month" ? "bg-indigo-600 text-white" : "bg-transparent"}`}>月</button>
            </div>
          </div>
        </aside>

        {/* Main (Gantt) */}
        <main className={`col-span-12 md:col-span-6 lg:col-span-7 ${card} rounded-xl p-3`}>
          {/* Timeline header */}
          <div className="grid gap-1 text-xs font-medium" style={{ gridTemplateColumns: `repeat(${totalDays}, 1fr)` }}>
            {headerDays.map((d, i) => (
              <div key={i} className="text-center opacity-80">
                {d.getMonth() + 1}/{d.getDate()} ({"日月火水木金土"[d.getDay()]})
              </div>
            ))}
          </div>

          {/* Rows */}
          <div className="mt-2 space-y-3">
            {visible.map((t) => (
              <GanttRow key={t.id} task={t} rangeStart={rangeStart} totalDays={totalDays} selected={t.id === selectedId} onSelect={() => setSelectedId(t.id)} theme={theme} />
            ))}
            {visible.length === 0 && <div className="text-sm opacity-70 p-4">該当タスクがありません</div>}
          </div>
        </main>

        {/* Detail Panel */}
        <section className={`col-span-12 md:col-span-3 lg:col-span-3 ${card} rounded-xl p-3 h-fit sticky top-16`}>
          <DetailPanel task={selected} onUpdate={updateTask} onShift={shiftTask} onAddMessage={addMessage} onCreateInvoice={createInvoice} theme={theme} />
        </section>
      </div>

      {showNew && <NewTaskModal onClose={() => setShowNew(false)} onCreate={createTask} theme={theme} />}
    </div>
  );

  // ===== helpers =====
  function createInvoice(task: Task | null) {
    if (!task) return;
    const win = window.open("", "_blank");
    if (!win) return;
    const html = `<!doctype html>
<html lang="ja"><head><meta charset="utf-8"/><title>Invoice - ${task.title}</title>
<style>body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; padding:24px;} h1{margin:0 0 8px} table{border-collapse:collapse;width:100%;} td,th{border:1px solid #ddd;padding:8px} .right{text-align:right}</style>
</head><body>
<h1>請求書</h1>
<p><strong>クライアント:</strong> ${task.client}<br/>
<strong>案件:</strong> ${task.project}<br/>
<strong>タスク:</strong> ${task.title}<br/>
<strong>期間:</strong> ${task.start} 〜 ${task.end}</p>
<table><thead><tr><th>内容</th><th class="right">数量</th><th class="right">単価</th><th class="right">金額</th></tr></thead>
<tbody><tr><td>${task.title}</td><td class="right">1</td><td class="right">¥50,000</td><td class="right">¥50,000</td></tr></tbody>
<tfoot><tr><th colspan="3" class="right">小計</th><th class="right">¥50,000</th></tr></tfoot>
</table>
<p>備考: デモ用の金額です。実運用では単価を編集できるように拡張します。</p>
<script>window.onload=()=>window.print()</script>
</body></html>`;
    win.document.write(html);
    win.document.close();
  }
}

// ===== UI Bits =====
function PresetButton({ label, active, onClick }: { label: string; active: boolean; onClick: () => void }) {
  return (
    <button onClick={onClick} className={`px-3 py-1 rounded border ${active ? "bg-indigo-600 text-white" : "bg-transparent"}`}>{label}</button>
  );
}

function GanttRow({ task, rangeStart, totalDays, selected, onSelect, theme }: { task: Task; rangeStart: Date; totalDays: number; selected: boolean; onSelect: () => void; theme: "light" | "dark"; }) {
  const start = parse(task.start);
  const end = parse(task.end);
  const first = rangeStart;
  const last = addDays(rangeStart, totalDays - 1);

  // clamp to visible
  const clampedStart = start < first ? first : start;
  const clampedEnd = end > last ? last : end;

  const colStart = Math.max(0, diffDays(clampedStart, first)); // 0-based
  const colSpan = Math.max(1, diffDays(clampedEnd, first) - diffDays(clampedStart, first) + 1);

  const overdue = end < new Date(fmt(today)) && task.status !== "Done";
  const rail = theme === "dark" ? "bg-neutral-700" : "bg-gray-100";
  const barColor = overdue ? "bg-red-500 hover:bg-red-600" : selected ? "bg-indigo-600" : "bg-indigo-500 hover:bg-indigo-600";

  return (
    <div className="border rounded-lg p-2">
      <div className="flex items-center justify-between text-sm">
        <div className="font-semibold flex items-center gap-2">
          {overdue && <span className="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded bg-red-100 text-red-700 border border-red-300">期限切れ</span>}
          {task.title}
        </div>
        <div className="opacity-70">{task.client} ・ {task.project}</div>
      </div>

      {/* rail */}
      <div className="relative mt-2" style={{ display: "grid", gridTemplateColumns: `repeat(${totalDays}, 1fr)`, gap: "4px" }}>
        {Array.from({ length: totalDays }).map((_, i) => (
          <div key={i} className={`h-7 ${rail} rounded`} />
        ))}
        {/* bar */}
        <div
          onClick={onSelect}
          title={`${task.title} (${task.start} → ${task.end})`}
          className={`absolute h-6 rounded shadow cursor-pointer transition-all text-white ${barColor}`}
          style={{
            left: `calc(${colStart} * (100% / ${totalDays}) + ${colStart * 4}px)`,
            width: `calc(${colSpan} * (100% / ${totalDays}) + ${(colSpan - 1) * 4}px)`,
            top: "4px",
          }}
        >
          <div className="h-full w-full flex items-center px-2 text-[11px]">{task.progress}%</div>
        </div>
      </div>
    </div>
  );
}

function DetailPanel({ task, onUpdate, onShift, onAddMessage, onCreateInvoice, theme }: { task: Task | null; onUpdate: (id: string, patch: Partial<Task>) => void; onShift: (id: string, dir: number) => void; onAddMessage: (id: string, text: string) => void; onCreateInvoice: (task: Task | null) => void; theme: "light" | "dark"; }) {
  const muted = "opacity-70";
  if (!task) return <div className={`text-sm ${muted}`}>左のタスクバーを選択すると詳細が表示されます。</div>;

  const [msg, setMsg] = useState("");

  return (
    <div>
      <div className={`${muted} text-sm mb-1`}>タスク詳細</div>
      <div className="text-lg font-bold">{task.title}</div>
      <div className={`${muted}`}>{task.client} ・ {task.project}</div>

      <div className="mt-3 space-y-3 text-sm">
        <div>
          <div className={`${muted}`}>期間</div>
          <div>{task.start} → {task.end}</div>
          <div className="flex flex-wrap gap-2 mt-1">
            <button className="px-2 py-1 border rounded" onClick={() => onShift(task.id, -1)}>◀ 1日前にずらす</button>
            <button className="px-2 py-1 border rounded" onClick={() => onShift(task.id, 1)}>1日後にずらす ▶</button>
          </div>
        </div>

        <div>
          <div className={`${muted}`}>進捗</div>
          <input type="range" min={0} max={100} value={task.progress} onChange={(e) => onUpdate(task.id, { progress: Number((e.target as HTMLInputElement).value) })} />
          <span className="ml-2">{task.progress}%</span>
        </div>

        <div>
          <div className={`${muted}`}>優先度</div>
          <select className="border rounded px-2 py-1 bg-transparent" value={task.priority} onChange={(e) => onUpdate(task.id, { priority: e.target.value as Task["priority"] })}>
            <option>High</option>
            <option>Medium</option>
            <option>Low</option>
          </select>
        </div>

        <div>
          <div className={`${muted}`}>ステータス</div>
          <select className="border rounded px-2 py-1 bg-transparent" value={task.status} onChange={(e) => onUpdate(task.id, { status: e.target.value as Task["status"] })}>
            <option>Planned</option>
            <option>In Progress</option>
            <option>Blocked</option>
            <option>Done</option>
          </select>
        </div>

        <div>
          <div className={`${muted}`}>クライアント依頼メモ（簡易チャット）</div>
          <div className={`border rounded p-2 ${theme === "dark" ? "border-neutral-700" : ""}`}>
            <ul className="space-y-1 mb-2">
              {(task.messages || []).map((m, i) => (
                <li key={i} className="text-[13px]">• {m}</li>
              ))}
              {(task.messages || []).length === 0 && <li className={`${muted}`}>メモなし</li>}
            </ul>
            <div className="flex gap-2">
              <input className="flex-1 border rounded px-2 py-1 bg-transparent" placeholder="例：修正点、依頼内容など" value={msg} onChange={(e) => setMsg(e.target.value)} />
              <button className="px-3 py-1 rounded bg-indigo-600 text-white" onClick={() => { if (msg.trim()) { onAddMessage(task.id, msg.trim()); setMsg(""); } }}>追加</button>
            </div>
          </div>
        </div>

        <div className="flex flex-wrap gap-2">
          <button className="px-3 py-2 rounded bg-indigo-600 text-white" onClick={() => alert("リマインダーを設定しました（デモ）")}>リマインダー</button>
          <button className="px-3 py-2 rounded border" onClick={() => onCreateInvoice(task)}>請求書を作成</button>
        </div>
      </div>
    </div>
  );
}

function NewTaskModal({ onClose, onCreate, theme }: { onClose: () => void; onCreate: (t: Omit<Task, "id">) => void; theme: "light" | "dark"; }) {
  const [title, setTitle] = useState("");
  const [client, setClient] = useState("");
  const [project, setProject] = useState("");
  const [start, setStart] = useState(fmt(new Date()));
  const [end, setEnd] = useState(fmt(addDays(new Date(), 3)));
  const [priority, setPriority] = useState<Task["priority"]>("Medium");

  const disabled = !title || !client || !project || start > end;

  return (
    <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
      <div className={`${theme === "dark" ? "bg-neutral-800" : "bg-white"} rounded-xl w-full max-w-lg p-4`}>
        <div className="flex items-center justify-between">
          <div className="text-lg font-bold">新規タスク</div>
          <button className="opacity-70" onClick={onClose}>✕</button>
        </div>
        <div className="mt-3 grid grid-cols-2 gap-3 text-sm">
          <label className="col-span-2">タイトル
            <input className="w-full border rounded px-2 py-1 bg-transparent" value={title} onChange={(e) => setTitle(e.target.value)} />
          </label>
          <label>クライアント
            <input className="w-full border rounded px-2 py-1 bg-transparent" value={client} onChange={(e) => setClient(e.target.value)} />
          </label>
          <label>プロジェクト
            <input className="w-full border rounded px-2 py-1 bg-transparent" value={project} onChange={(e) => setProject(e.target.value)} />
          </label>
          <label>開始日
            <input type="date" className="w-full border rounded px-2 py-1 bg-transparent" value={start} onChange={(e) => setStart((e.target as HTMLInputElement).value)} />
          </label>
          <label>終了日
            <input type="date" className="w-full border rounded px-2 py-1 bg-transparent" value={end} onChange={(e) => setEnd((e.target as HTMLInputElement).value)} />
          </label>
          <label>優先度
            <select className="w-full border rounded px-2 py-1 bg-transparent" value={priority} onChange={(e) => setPriority(e.target.value as Task["priority"]) }>
              <option>High</option>
              <option>Medium</option>
              <option>Low</option>
            </select>
          </label>
        </div>
        <div className="mt-4 flex justify-end gap-2">
          <button className="px-3 py-2 rounded border" onClick={onClose}>キャンセル</button>
          <button className={`px-3 py-2 rounded ${disabled ? "bg-gray-300 text-gray-600" : "bg-indigo-600 text-white"}`} disabled={disabled} onClick={() => onCreate({ title, client, project, start, end, priority, progress: 0, notes: "", status: "Planned", messages: [] })}>作成</button>
        </div>
      </div>
    </div>
  );
}

